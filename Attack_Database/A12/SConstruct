#!/usr/bin/env python
import os
import sys

# --- Configuration ---
# Set the name of your extension library file prefix
LIBRARY_NAME = 'logi_steering_wheel_gde'
# Define the source directory
SOURCE_DIR = 'src'
# Define the output directory for the compiled library
BIN_DIR = 'steering-wheel-godot/bin'
# Define the path to your godot-cpp repository
GODOT_CPP_ROOT = 'godot-cpp-4.5' 

# Load the SCons environment from godot-cpp
# This sets up all the necessary compilation flags, paths, and platform variables.
env = SConscript(os.path.join(GODOT_CPP_ROOT, 'SConstruct'))

# Add the path to your source files so includes like #include "logi_steering_wheel.h" work
env.Append(CPPPATH=[SOURCE_DIR])
# Find all .cpp files in the source directory
sources = Glob(os.path.join(SOURCE_DIR, '*.cpp'))

# --- Logitech SDK Configuration (CRITICAL for this project) ---
# NOTE: Adjust these paths based on where your SDK files are located.

# 1. Add the library directory (where the .lib or .so is located)
# Example: Assuming the library file (e.g., 'LogitechSteeringWheelLib.lib') is in 'sdk/lib'
env.Append(LIBPATH=['src'])

# 2. Link the required Logitech SDK library file
env.Append(LIBS=['LogitechSteeringWheelLib']) 

# --- Platform-Specific Build Rules ---

library = None

if env["platform"] == "windows":
    # On Windows, link the necessary DirectInput libraries
    env.Append(LIBS=['dinput8', 'dxguid','advapi32'])
    
    # Standard Windows shared library target
    library = env.SharedLibrary(
        os.path.join(BIN_DIR, "{}{}".format(LIBRARY_NAME, env["SHLIBSUFFIX"])),
        source=sources,
    )
    
elif env["platform"] == "macos":
    # MacOS uses the .framework structure
    # Note: We use the platform and target in the folder name as per the example
    library_name_with_ext = "{}.{}.{}.framework/{}".format(
        LIBRARY_NAME, env["platform"], env["target"], LIBRARY_NAME
    )
    library = env.SharedLibrary(
        os.path.join(BIN_DIR, library_name_with_ext),
        source=sources,
    )

elif env["platform"] == "ios":
    # iOS uses static libraries (.a)
    if env["ios_simulator"]:
        library = env.StaticLibrary(
            os.path.join(BIN_DIR, "{}.{}.{}.simulator.a".format(LIBRARY_NAME, env["platform"], env["target"])),
            source=sources,
        )
    else:
        library = env.StaticLibrary(
            os.path.join(BIN_DIR, "{}.{}.{}.a".format(LIBRARY_NAME, env["platform"], env["target"])),
            source=sources,
        )
        
else:
    # Default: Linux, Android, etc. (uses .so or similar)
    library = env.SharedLibrary(
        os.path.join(BIN_DIR, "{}{}".format(LIBRARY_NAME, env["SHLIBSUFFIX"])),
        source=sources,
    )

# Set the result of the build as the default target
Default(library)
